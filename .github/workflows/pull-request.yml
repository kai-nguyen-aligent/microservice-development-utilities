name: Pull request check

on: [pull_request]

permissions:
  actions: read
  contents: write

jobs:
  code-quality:
    if: ${{ !startsWith(github.head_ref, 'releases/') }}
    name: üïµÔ∏è‚Äç‚ôÄÔ∏è Code Quality Check
    runs-on: ubuntu-latest
    steps:
      - name: Display Environment Info
        run: |
          echo "Runner Machine Name: $(hostname)"
          echo "Operating System: $(uname)"
          echo "Commit SHA: $GITHUB_SHA"
          echo "Git Ref: $GITHUB_REF"
          echo "Head Ref: ${{ github.event.pull_request.head.ref }}"
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.ref }}

      - name: Fetch target
        env:
          BASE_REF: ${{ github.event.pull_request.base.ref }}
        run: git fetch origin ${{ env.BASE_REF }}

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Derive appropriate SHAs for base and head for `nx affected` commands
        uses: nrwl/nx-set-shas@dbe0650947e5f2c81f59190a38512cf49126fe6b # v4

      - name: ‚öôÔ∏è Run Tests
        run: npx nx affected -t lint test --parallel=2

      - name: ‚öôÔ∏è Run Build
        run: npx nx affected -t build

      - name: ‚öôÔ∏è Run release plan check
        run: npx nx release plan:check --verbose
